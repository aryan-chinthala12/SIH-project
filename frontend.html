<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SIH Chatbot + Questionnaire</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f8; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 250px; overflow-y: auto; background: #fff; }
    .user { text-align: right; color: blue; margin: 5px 0; }
    .bot { text-align: left; color: green; margin: 5px 0; }
    .system { text-align: center; color: gray; font-style: italic; }
    #msg { width: 70%; padding: 5px; }
    button { padding: 6px 12px; margin-left: 5px; }
    .q-block { margin-bottom: 10px; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>üí¨ SIH Chatbot</h2>
  <div id="chat"></div>
  <br>
  <input id="msg" placeholder="Type a message...">
  <button id="send">Send</button>

  <h2>üìù Questionnaire</h2>
  <form id="qform"></form>
  <button id="submitQ">Submit Questionnaire</button>

  <div id="qResult"></div>

<script>
const API = "http://localhost:5000";
let session = null;

// Utility: append to chat
function addMessage(from, text) {
  const div = document.getElementById("chat");
  const p = document.createElement("div");
  p.className = from;
  p.textContent = (from === "user" ? "You: " : from === "bot" ? "Bot: " : "") + text;
  div.appendChild(p);
  div.scrollTop = div.scrollHeight;
}

// Chat handler
document.getElementById("send").onclick = async () => {
  const txt = document.getElementById("msg").value.trim();
  if (!txt) return;
  addMessage("user", txt);
  document.getElementById("msg").value = "";
  try {
    const res = await fetch(API + "/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ message: txt, session_id: session })
    });
    const data = await res.json();
    session = data.session_id;
    addMessage("bot", data.reply);
  } catch (err) {
    addMessage("system", "‚ùå Error: cannot reach backend.");
  }
};

// Load questionnaire
async function loadQuestions() {
  const res = await fetch(API + "/questionnaire");
  const data = await res.json();
  const form = document.getElementById("qform");
  data.questions.forEach(q => {
    const block = document.createElement("div");
    block.className = "q-block";
    block.innerHTML = `<b>${q.text}</b><br>` +
      [0,1,2,3].map(v =>
        `<label><input type="radio" name="${q.id}" value="${v}" ${v===0?"checked":""}> ${v}</label>`
      ).join(" ");
    form.appendChild(block);
  });
}
loadQuestions();

// Submit questionnaire
document.getElementById("submitQ").onclick = async (e) => {
  e.preventDefault();
  const answers = {};
  document.querySelectorAll("#qform input:checked").forEach(inp => {
    answers[inp.name] = parseInt(inp.value);
  });
  try {
    const res = await fetch(API + "/questionnaire", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ session_id: session, answers })
    });
    const data = await res.json();
    document.getElementById("qResult").innerHTML =
      `<p><b>Score:</b> ${data.score}/${data.max_score}</p>
       <p><b>Category:</b> ${data.category}</p>
       <p><b>Advice:</b> ${data.advice}</p>`;
    addMessage("system", `üìä Questionnaire submitted (Score: ${data.score}/${data.max_score}, ${data.category})`);
  } catch (err) {
    document.getElementById("qResult").innerText = "‚ùå Error submitting questionnaire.";
  }
};
</script>
</body>
</html>
